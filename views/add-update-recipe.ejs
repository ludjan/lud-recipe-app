<!DOCTYPE html>
<html>
  <head>
    <title>Recipe - Add or edit recipe</title>
  </head>
  <body>
    <div>
      <h1 id="recipe-heading">New recipe</h1>
      <form id="save-recipe-form" onsubmit="return false">
        <label for="recipe-name">Recipe name</label><br />
        <input id="recipe-name" type="text" name="hest" /><br />
        <label for="recipe-description">Recipe Description</label><br />
        <input id="recipe-description" type="text" name="hist" />
        <br />
        <br />
        <input type="submit" id="save-recipe-btn" value="Submit" />
      </form>

      <br />
      <br />
      <div id="recipe-ingredient-feed"></div>
      <br />
      <button id="add-ingredient-input-btn">Add ingredient input</button>

      <br />
      <br />
      <div id="recipe-step-feed"></div>
      <br />
      <button id="add-step-input-btn">Add recipe input</button>

      <br />
      <br />
      <button id="before-send-btn">
        Before send button (logs what will be sent)
      </button>

      <br />
      <br />
      <button id="dummy-create">Dummy</button>

      <div id="recipeId"></div>
    </div>

    <script src="/static/js/api_calls.js"></script>
    <script src="/static/js/ingredients.js"></script>
    <script src="/static/js/steps.js"></script>
    <script src="/static/js/check_input.js"></script>
    <script src="/static/js/utils.js"></script>
    <script type="text/javascript">
      const recipeHeading = document.getElementById('recipe-heading');
      const recipeNameInput = document.getElementById('recipe-name');
      const recipeDescriptionInput =
        document.getElementById('recipe-description');
      const saveRecipeForm = document.getElementById('save-recipe-form');

      // for testing
      const dummyCreateButton = document.getElementById('dummy-create');
      const beforeSendBtn = document.getElementById('before-send-btn');

      // ejs values
      var data = '<%- JSON.stringify(data) %>';
      var rId;

      // are set by fetch
      var ingredients = [];
      var units = [];

      // getIngredients()
      //   .then((response) => response.json())
      //   .then((data) => {
      //     console.log(data);
      //     ingredients = data;
      //     // appendIngredientsToSelect(data, ingredientsSelect)
      //   });

      // getUnits()
      //   .then((response) => response.json())
      //   .then((data) => {
      //     console.log(data);
      //     units = data;
      //     // appendUnitToSelect(data, unitSelect)
      //   });

      console.log(`data: ${data}`);
      ('<% if (data != -1) { %>');
      rId = '<%= data %>';
      recipeHeading.innerText = 'Edit recipe';
      recipeNameInput.value = '<%= data.name %>';
      recipeDescriptionInput.value = '<%= data.description %>';
      ('<%}%>');

      saveRecipeForm.addEventListener('submit', () => {
        const recipeName = recipeNameInput.value;
        const recipeDescription = recipeDescriptionInput.value;

        if (!isAlphaNumeric(recipeName)) {
          return alert(`Name '${recipeName}' is not alphanumeric`);
        }
        if (!isAlphaNumeric(recipeDescription)) {
          return alert(
            `Description '${recipeDescription}' is not alphanumeric`
          );
        }

        // // create the new entry
        // const newRecipe = {
        //   name: recipeNameInput.value,
        //   description: recipeDescriptionInput.value
        // }
        // console.log(newRecipe)

        // console.log(`Data = ${data}`)

        // if (rId == null) {

        //   // async add, then re-render
        //   addRecipe(newRecipe).then(response => {
        //     if (!response.ok) {
        //       const errorMessage = `Error ${response.status} - ${response.statusText}`
        //       console.log(errorMessage)
        //     } else {
        //       window.location.pathname = ('/..') // navigates user back to main page
        //     }
        //   })

        // } else {
        //   console.log(`About to update recipe with id ${rId}`)
        //   updateRecipe(newRecipe, rId).then(response => {
        //     if (!response.ok) {
        //       const errorMessage = `Error ${response.status} - ${response.statusText}`
        //       console.log(errorMessage)
        //       return alert(errorMessage)
        //     } else {
        //       window.location.pathname = (`/../recipes/${rId}`)
        //     }
        //   })
        // }
      });

      addIngredientInputBtn.addEventListener('click', () => {
        saveCurrentIngredientInputs();
        recipeIngredientArray.push({
          ingredient: null,
          quantity: null,
          unit: null,
        });
        rerenderRecipeIngredientsFeed();
      });

      addStepInputBtn.addEventListener('click', () => {
        saveCurrentStepInputs();
        recipeStepArray.push(''); // push an empty string as the last element of recipeStepArray
        rerenderRecipeSteps();
      });

      beforeSendBtn.addEventListener('click', () => {
        console.log('beforeSendButton was clicked');

        // the object we are sending
        var newRecipe = {
          recipe: {
            name: null,
            description: null,
            portions: null,
          },
          ingredients: null,
          steps: null,
        };

        // recipe
        newRecipe.recipe.name = recipeNameInput.value;
        newRecipe.recipe.description = recipeDescriptionInput.value;
        newRecipe.recipe.portions = 2; // for testing

        // ingredients
        saveCurrentIngredientInputs();
        newRecipe.ingredients = getFormattedRecipeIngredients();

        // steps
        saveCurrentStepInputs();
        newRecipe.steps = getFormattedRecipeSteps();

        console.log(`About to send:`);
        console.log(newRecipe);

        updateFullRecipe(newRecipe).then((response) => {
          if (!response.ok) {
            const errorMessage = `Error ${response.status} - ${response.statusText}`;
            console.log(errorMessage);
            return alert(errorMessage);
          } else {
            window.location.pathname = `/..`;
          }
        });
      });

      dummyCreateButton.addEventListener('click', () => {
        const newRecipe = {
          recipe: {
            name: 'Goda pannkakor',
            description: 'Supergoda pannkakor',
            portions: 4,
          },
          ingredients: [
            {
              ingredientId: 2,
              quantity: 2,
              unit: 'piece',
            },
            {
              ingredientId: 4,
              quantity: 2,
              unit: 'spicespoon',
            },
            {
              ingredientId: 3,
              quantity: 2,
              unit: 'deciliter',
            },
            {
              ingredientId: 5,
              quantity: 4,
              unit: 'deciliter',
            },
          ],
          steps: [
            {
              description: 'A first step',
            },
            {
              description: 'A second step',
            },
            {
              description: 'A third step',
            },
          ],
        };
        console.log(`About to create ${newRecipe}`);
        createFullRecipe(newRecipe).then((response) => {
          if (!response.ok) {
            const errorMessage = `Error ${response.status} - ${response.statusText}`;
            console.log(errorMessage);
            return alert(errorMessage);
          } else {
            window.location.pathname = `/..`;
          }
        });
      });

      // if new entry, then rId is set to -1
      if (data != -1) {
        console.log(`About to get full recipe with id ${data}`);
        var id = data.id;
        console.log(`Id: ${id}`);

        // fetch the recipe, available ingredients and units
        Promise.all([getFullRecipe(1), getIngredients(), getUnits()])
          .then((responses) => Promise.all(responses.map((res) => res.json())))
          .then(([recipeResponse, ingredientResponse, unitResponse]) => {
            // ingredients and units must be set first
            ingredients = ingredientResponse;
            console.log(ingredients);
            units = unitResponse;
            console.log(units);
            // recipe
            recipeIngredientArray = recipeResponse.ingredients;
            recipeStepArray = getStepDescriptionArray(recipeResponse.steps);
            // rerender the feeds
            rerenderRecipeIngredientsFeed();
            rerenderRecipeStepsFeed();
          });
      }
    </script>
  </body>
</html>
